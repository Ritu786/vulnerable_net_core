trigger:
  branches:
    include: [ main, master ]

pr:
  branches:
    include: [ main, master ]

variables:
- group: blackduck-secrets
- name: COVERITY_BIN
  value: 'C:\Program Files\Coverity\Coverity Static Analysis\bin'
- name: buildConfiguration
  value: 'Release'
- name: projectName
  value: 'VulnerableNetCoreDemo'

stages:
# 1) Build & Test on Windows (coverity-win)
- stage: Build
  displayName: Build & Test (.NET)
  jobs:
  - job: build_dotnet
    pool: { name: coverity-win }
    steps:
    - checkout: self
    # âœ… need 3.1 SDK for netcoreapp3.1
    - task: UseDotNet@2
      inputs: { packageType: 'sdk', version: '3.1.426' }
    - task: UseDotNet@2
      inputs: { packageType: 'sdk', version: '8.x' }
    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs: { command: 'restore', projects: '**/*.sln' }
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: 'build'
        projects: '**/*.sln'
        arguments: '--configuration $(buildConfiguration)'
    - task: DotNetCoreCLI@2
      displayName: Test
      inputs:
        command: 'test'
        projects: '**/*Tests/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build'

# 2) Coverity SAST on Windows (MSBuild capture)
- stage: Coverity
  displayName: Coverity SAST
  dependsOn: Build
  jobs:
  - job: coverity_sast
    pool: { name: coverity-win }
    steps:
    - checkout: self
    - task: UseDotNet@2
      inputs: { packageType: 'sdk', version: '3.1.426' }
    - task: UseDotNet@2
      inputs: { packageType: 'sdk', version: '8.x' }
    - task: DownloadSecureFile@1
      name: covAuth
      inputs: { secureFile: 'auth-key.txt' }
    - powershell: |
        $ErrorActionPreference = 'Stop'
        $covRoot  = 'C:\Program Files\Coverity'
        $covBuild = Get-ChildItem -Path $covRoot -Recurse -Filter 'cov-build.exe' -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
        if (-not $covBuild) { throw "cov-build.exe not found under $covRoot" }
        $covBin = Split-Path $covBuild -Parent
        $env:PATH = "$covBin;$env:PATH"
        Write-Host "Using Coverity bin: $covBin"
        New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)\logs" | Out-Null
        $logsDir = "$(Build.ArtifactStagingDirectory)\logs"
        $binlog  = Join-Path $logsDir "msbuild.binlog"
        $txtlog  = Join-Path $logsDir "msbuild.txt"
        $sln = Get-ChildItem -Path "$(Build.SourcesDirectory)" -Filter *.sln -Recurse | Select-Object -First 1
        if (-not $sln) { throw "No .sln found under $(Build.SourcesDirectory)" }
        dotnet restore "`"$($sln.FullName)`""
        if (Test-Path cov-int) { Remove-Item cov-int -Recurse -Force }
        cov-build --dir cov-int dotnet msbuild "`"$($sln.FullName)`"" /m `
          /t:Rebuild /p:Configuration=$(buildConfiguration) `
          /p:GenerateFullPaths=true /nr:false `
          /bl:"$binlog" "/flp:LogFile=$txtlog;verbosity=normal"
        if ($LASTEXITCODE -ne 0) { throw "Build failed. See $binlog / $txtlog." }
        cov-analyze --dir cov-int --all
        cov-format-errors --dir cov-int --html-output cov-html

        # Export files SRM can ingest
        cov-format-errors --dir cov-int --json-output-v10 coverity.json

        cov-commit-defects --dir cov-int `
          --url "$(COVERITY_URL)" `
          --stream "$(COVERITY_STREAM)" `
          --auth-key-file "$(covAuth.secureFilePath)" `
          --description "ADO $(Build.BuildNumber) $(Build.SourceVersion)" `
          --on-new-cert trust
      displayName: Capture, Analyze & Commit
    - task: PublishBuildArtifacts@1
      displayName: Publish diagnostic logs
      condition: always()
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/logs'
        ArtifactName: 'diag-logs'
    - task: PublishBuildArtifacts@1
      displayName: Publish Coverity HTML
      condition: succeeded()
      inputs:
        PathtoPublish: 'cov-html'
        ArtifactName: 'coverity-report'      
    - task: PublishBuildArtifacts@1
      displayName: Publish SRM inputs (Coverity)
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)'
        ArtifactName: 'srm-inputs'


# 3) Black Duck SCA on Linux
- stage: BlackDuck
  displayName: Black Duck SCA
  dependsOn: Coverity
  jobs:
  - job: bd_scan
    pool: { name: blackduck-linux }
    steps:
    - checkout: self
    - bash: |
        set -e
        curl -s -L https://detect.synopsys.com/detect9.sh -o detect.sh
        chmod +x detect.sh
        ./detect.sh \
          --blackduck.url="$(BD_URL)" \
          --blackduck.api.token="$(BD_API_TOKEN)" \
          --blackduck.trust.cert=true \
          --detect.project.name="@HooliCorp/vulnerable_net_core" \
          --detect.project.version.name="$(Build.SourceVersion)" \
          --detect.policy.check=true \
          --detect.cleanup=true \
          --detect.timeout=1200
      displayName: Black Duck Detect (SCA)
  
# 4) SRM ingest (auto-pick CLI asset from GitHub)
- stage: SRM
  displayName: Software Risk Manager ingest
  dependsOn:
    - Coverity
    - BlackDuck
  variables:
  - group: srm-secrets      # SRM_BASE_URL, SRM_API_KEY, SRM_PROJECT_ID
  jobs:
  - job: srm_push
    displayName: Push findings to SRM
    pool: { name: blackduck-linux }
    steps:
    - checkout: none

    - task: DownloadBuildArtifacts@1
      displayName: Download SRM inputs
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'srm-inputs'
        downloadPath: '$(Pipeline.Workspace)'

    - bash: |
        set -euo pipefail
        cd "$(Pipeline.Workspace)/srm-inputs"

        # --- 1) Ensure input exists ---
        if [ ! -f coverity.json ]; then
          echo "No coverity.json found; nothing to upload."
          exit 0
        fi

        # --- 2) Download the Code Dx / SRM CLI tarball (pinned) ---
        URL="https://github.com/codedx/codedx-cli-client/releases/download/v0.3.0/codedx-client-v0.3.0-linux-x86_64.tar.bz2"
        echo "Downloading SRM CLI from: $URL"
        curl -fL "$URL" -o codedx-cli.tar.bz2

        # --- 3) Extract (install bzip2 if needed on this self-hosted agent) ---
        mkdir -p cli
        if ! tar -xjf codedx-cli.tar.bz2 -C cli 2>/dev/null; then
          echo "tar -xjf failed; attempting to install bzip2 (requires sudo)..."
          sudo apt-get update -y && sudo apt-get install -y bzip2
          tar -xjf codedx-cli.tar.bz2 -C cli
        fi

        # Find the CLI binary inside the extracted folder
        CLI="$(find cli -type f -name 'codedx-client*' | head -n1)"
        if [ -z "$CLI" ]; then
          echo "codedx-client executable not found after extraction."
          exit 1
        fi
        chmod +x "$CLI"

        # --- 4) Normalize SRM base URL (auto-append /codedx if needed) ---
        BASE="$(SRM_BASE_URL)"
        try_projects () { "$CLI" "$1" --api-key "api-key:$(SRM_API_KEY)" --insecure projects >/dev/null 2>&1; }

        if ! try_projects "$BASE"; then
          ALT="${BASE%/}/codedx"
          echo "SRM base '$BASE' did not respond; retrying with '$ALT'..."
          if try_projects "$ALT"; then
            BASE="$ALT"
          else
            echo "Unable to reach SRM at '$BASE' or '$ALT'. Check SRM_BASE_URL and cert."
            exit 1
          fi
        fi

        # --- 5) Upload Coverity results ---
        echo "Uploading to SRM project $(SRM_PROJECT_ID) at $BASE: coverity.json"
        "$CLI" "$BASE" \
          --api-key "api-key:$(SRM_API_KEY)" \
          --insecure \
          analyze "$(SRM_PROJECT_ID)" coverity.json
      displayName: Upload results to SRM
